% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/gap_detection.R
\name{detect_morphospace_gaps}
\alias{detect_morphospace_gaps}
\title{Detect Morphospace Gaps with Uncertainty Quantification}
\usage{
detect_morphospace_gaps(
  pca_scores,
  uncertainty = 0.05,
  grid_resolution = 150,
  monte_carlo_iterations = 100,
  bootstrap_iterations = 200,
  certainty_thresholds = c(0.8, 0.9, 0.95),
  pc_pairs = NULL,
  max_pcs = 4,
  hull_type = "alpha",
  alpha_value = NULL,
  hull_buffer = 0.05,
  use_parallel = FALSE,
  n_cores = NULL,
  uncertainty_type = "gaussian",
  occupancy_method = "radius",
  occupancy_radius = 1.5,
  progress_callback = NULL,
  verbose = TRUE
)
}
\arguments{
\item{pca_scores}{Data frame or matrix containing PC scores. Must have
columns named PC1, PC2, PC3, etc.}

\item{uncertainty}{Numeric between 0 and 1. Proportion of axis range to use
as uncertainty radius (default: 0.05 for 5% uncertainty).}

\item{grid_resolution}{Integer. Number of grid cells along each axis
(default: 150). Higher values increase precision but slow computation.}

\item{monte_carlo_iterations}{Integer. Number of Monte Carlo replicates for
measurement uncertainty (default: 100). More iterations improve stability.}

\item{bootstrap_iterations}{Integer. Number of bootstrap resamples for
sampling uncertainty (default: 200).}

\item{certainty_thresholds}{Numeric vector of gap certainty thresholds for
polygon extraction (default: c(0.80, 0.90, 0.95)).}

\item{pc_pairs}{Optional matrix with 2 columns specifying PC pairs to
analyze (e.g., matrix(c(1,2, 1,3), ncol=2, byrow=TRUE)). If NULL,
analyzes all pairs up to max_pcs.}

\item{max_pcs}{Integer. Maximum PC to include in automatic pair generation
(default: 4, analyzing PC1-PC4).}

\item{hull_type}{Character. Type of hull for domain constraint: "alpha"
(concave alpha hull, preferred) or "convex" (default: "alpha").}

\item{alpha_value}{Numeric. Alpha parameter for alphahull (default: NULL,
auto-determined).}

\item{hull_buffer}{Numeric. Proportional buffer to add around hull
(default: 0.05 for 5%).}

\item{use_parallel}{Logical. Use parallel processing if available
(default: FALSE).}

\item{n_cores}{Integer. Number of cores for parallel processing. If NULL,
uses detectCores() - 1 (default: NULL).}

\item{uncertainty_type}{Character. Type of uncertainty model: "gaussian"
(bivariate normal) or "uniform" (uniform within ±u, default: "gaussian").}

\item{occupancy_method}{Character. Method to determine cell occupancy:
"radius" (point within radius) or "kde" (kernel density estimation,
default: "radius").}

\item{occupancy_radius}{Numeric. Radius for occupancy detection as
proportion of grid cell size (default: 1.5).}

\item{progress_callback}{Optional function to call for progress updates.
Should accept two arguments: message (character) and increment (numeric 0-1).}

\item{verbose}{Logical. Print progress messages (default: TRUE).}
}
\value{
A list of class "morphospace_gaps" containing:
  \describe{
    \item{pc_pairs}{Matrix of analyzed PC pairs}
    \item{results}{List with one element per PC pair, each containing: grid_x (x-axis grid coordinates), grid_y (y-axis grid coordinates), gap_probability (matrix of gap probability from measurement uncertainty), gap_stability (matrix of gap stability from sampling uncertainty), gap_certainty (matrix of combined certainty = probability * stability), gap_polygons (sf object with gap polygons at each threshold), gap_metrics (data frame with gap polygon metrics), domain_hull (sf polygon of analysis domain)}
    \item{summary_table}{Data frame summarizing all gaps across PC pairs}
    \item{parameters}{List of analysis parameters}
  }
}
\description{
Identifies regions of constraint (gaps) in morphospace derived from PCA of
Elliptic Fourier Analysis (EFA) coefficients. Uses Monte Carlo simulation
to account for measurement uncertainty and bootstrap resampling to assess
sampling uncertainty. Analyzes all pairwise PC combinations.
}
\details{
The function implements a rigorous two-stage uncertainty analysis:

\strong{Stage 1: Measurement Uncertainty (Monte Carlo)}
Each observed point is treated as uncertain within ±u (uncertainty * axis range).
For each Monte Carlo iteration, points are perturbed according to the
uncertainty model (Gaussian or uniform). Grid cells are marked as occupied
if any perturbed point falls within the occupancy radius. The gap probability
for each cell is the proportion of iterations where it remains unoccupied.

\strong{Stage 2: Sampling Uncertainty (Bootstrap)}
To assess whether gaps are artifacts of limited sampling, the dataset is
resampled (with replacement) B times. For each resample, the Monte Carlo
procedure is repeated and a binary gap mask is created. The gap stability
for each cell is the proportion of bootstrap iterations where it was
classified as a gap.

\strong{Combined Certainty}
gap_certainty = gap_probability * gap_stability
This represents the probability that a region is genuinely unoccupied,
accounting for both measurement and sampling uncertainty.
}
\examples{
\dontrun{
# Assuming pca_result from PCA() contains $x with PC scores
gaps <- detect_morphospace_gaps(
  pca_scores = pca_result$x,
  uncertainty = 0.05,
  grid_resolution = 150,
  monte_carlo_iterations = 100,
  bootstrap_iterations = 200,
  max_pcs = 3
)

# View summary
print(gaps$summary_table)

# Access results for PC1-PC2
pc1_pc2_gaps <- gaps$results$`PC1-PC2`
plot(pc1_pc2_gaps$gap_certainty)
}

}
